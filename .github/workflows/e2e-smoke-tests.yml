name: E2E Smoke Tests (Quick)

on:
  push:
    branches: [ "**" ] # Run on all branches
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/e2e-smoke-tests.yml"

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Shorter timeout for smoke tests

    # Only run the critical path tests
    strategy:
      matrix:
        test-file:
          - "chore-submission.spec.ts"
          # Add other critical test files here as they're created

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Create Docker network and start DynamoDB (same approach as full E2E)
    - name: Start DynamoDB Local
      run: |
        docker network create e2e-network
        docker run -d --name dynamodb --network e2e-network -p 8000:8000 amazon/dynamodb-local:latest
        sleep 5
        curl -sf http://localhost:8000 || echo "DynamoDB started"

    - name: Setup Python and Node
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/work/kids_rewards/kids_rewards/frontend/node_modules
          ~/.cache/ms-playwright
        key: ${{ runner.os }}-deps-${{ hashFiles('**/requirements.txt', '**/package-lock.json') }}

    - name: Quick setup
      run: |
        # Backend deps
        pip install -r backend/requirements.txt
        pip install aws-sam-cli

        # Frontend deps
        cd frontend && npm ci && cd ..

        # Only install Chromium for speed
        cd frontend && npx playwright install chromium && cd ..

        # AWS config for DynamoDB local
        aws configure set aws_access_key_id test
        aws configure set aws_secret_access_key test
        aws configure set region us-east-1

    - name: Setup test environment
      run: |
        # Create tables with correct schemas
        # Users table uses username as primary key
        aws dynamodb create-table \
          --table-name KidsRewardsUsers \
          --attribute-definitions AttributeName=username,AttributeType=S \
          --key-schema AttributeName=username,KeyType=HASH \
          --provisioned-throughput ReadCapacityUnits=1,WriteCapacityUnits=1 \
          --endpoint-url http://localhost:8000 || true

        # Other tables use id as primary key
        cd backend
        python << 'TABLE_SCRIPT'
        import subprocess

        tables = ['KidsRewardsStoreItems', 'KidsRewardsPurchaseLogs',
                  'KidsRewardsChores', 'KidsRewardsChoreLogs', 'KidsRewardsRequests',
                  'KidsRewardsChoreAssignments', 'KidsRewardsPets', 'KidsRewardsPetCareSchedules',
                  'KidsRewardsPetCareTasks', 'KidsRewardsPetHealthLogs']

        for table in tables:
            cmd = f'aws dynamodb create-table --table-name {table} --attribute-definitions AttributeName=id,AttributeType=S --key-schema AttributeName=id,KeyType=HASH --provisioned-throughput ReadCapacityUnits=1,WriteCapacityUnits=1 --endpoint-url http://localhost:8000'
            subprocess.run(cmd, shell=True, capture_output=True)
        print('Tables created')
        TABLE_SCRIPT

        # Seed test data
        python << 'SEED_SCRIPT'
        import boto3
        from passlib.context import CryptContext
        from datetime import datetime
        import uuid

        dynamodb = boto3.resource('dynamodb', endpoint_url='http://localhost:8000', region_name='us-east-1')
        users_table = dynamodb.Table('KidsRewardsUsers')
        chores_table = dynamodb.Table('KidsRewardsChores')

        pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

        # Create test users
        users_table.put_item(Item={
            'id': 'testparent',
            'username': 'testparent',
            'hashed_password': pwd_context.hash('password456'),
            'role': 'parent',
            'points': 0
        })

        users_table.put_item(Item={
            'id': 'testkid',
            'username': 'testkid',
            'hashed_password': pwd_context.hash('password123'),
            'role': 'kid',
            'points': 100
        })
        print('Test users created')

        # Create test chores
        chores_table.put_item(Item={
            'id': str(uuid.uuid4()),
            'name': 'Clean Room',
            'description': 'Make bed and organize toys',
            'points_value': 10,
            'created_by_parent_id': 'testparent',
            'created_at': datetime.utcnow().isoformat(),
            'updated_at': datetime.utcnow().isoformat(),
            'is_active': 'true'
        })

        chores_table.put_item(Item={
            'id': str(uuid.uuid4()),
            'name': 'Do Homework',
            'description': 'Complete all assignments',
            'points_value': 15,
            'created_by_parent_id': 'testparent',
            'created_at': datetime.utcnow().isoformat(),
            'updated_at': datetime.utcnow().isoformat(),
            'is_active': 'true'
        })
        print('Test chores created')
        SEED_SCRIPT

        # Build SAM
        sam build -t template.yaml

        # Start backend with Docker network for DynamoDB access
        cat > local-env.json << EOF
        {
          "KidsRewardsLambdaFunction": {
            "DYNAMODB_ENDPOINT_OVERRIDE": "http://dynamodb:8000",
            "USERS_TABLE_NAME": "KidsRewardsUsers",
            "STORE_ITEMS_TABLE_NAME": "KidsRewardsStoreItems",
            "PURCHASE_LOGS_TABLE_NAME": "KidsRewardsPurchaseLogs",
            "CHORES_TABLE_NAME": "KidsRewardsChores",
            "CHORE_LOGS_TABLE_NAME": "KidsRewardsChoreLogs",
            "REQUESTS_TABLE_NAME": "KidsRewardsRequests",
            "CHORE_ASSIGNMENTS_TABLE_NAME": "KidsRewardsChoreAssignments",
            "PETS_TABLE_NAME": "KidsRewardsPets",
            "PET_CARE_SCHEDULES_TABLE_NAME": "KidsRewardsPetCareSchedules",
            "PET_CARE_TASKS_TABLE_NAME": "KidsRewardsPetCareTasks",
            "PET_HEALTH_LOGS_TABLE_NAME": "KidsRewardsPetHealthLogs",
            "APP_SECRET_KEY": "test-secret-key-32chars-minimum!"
          }
        }
        EOF

        sam local start-api -t template.yaml \
          --env-vars local-env.json \
          --warm-containers LAZY \
          --docker-network e2e-network \
          --parameter-overrides "AppImageUri=kidsrewardslambdafunction:latest TableNamePrefix=local- LocalDynamoDBEndpoint=http://dynamodb:8000" \
          > backend.log 2>&1 &
        cd ..

    - name: Wait for backend
      run: |
        timeout 90 bash -c 'until curl -sSf http://localhost:3000/hello > /dev/null 2>&1; do echo "Waiting for backend..."; sleep 2; done'
        echo "Backend is ready"

    - name: Start frontend
      run: |
        cd frontend
        PORT=3001 REACT_APP_API_URL=http://localhost:3000 npm start > frontend.log 2>&1 &
        timeout 60 bash -c 'until curl -sSf http://localhost:3001 > /dev/null 2>&1; do echo "Waiting for frontend..."; sleep 2; done'
        echo "Frontend is ready"

    - name: Run smoke test - ${{ matrix.test-file }}
      run: |
        cd frontend
        npx playwright test ${{ matrix.test-file }} --project=chromium --reporter=list
      env:
        PLAYWRIGHT_BASE_URL: http://localhost:3001

    - name: Upload failure artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: smoke-test-failure-${{ matrix.test-file }}
        path: |
          frontend/playwright-report/
          frontend/test-results/
        retention-days: 3

    - name: Upload backend logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: backend-logs-${{ matrix.test-file }}
        path: backend/backend.log
        retention-days: 3

    - name: Upload frontend logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: frontend-logs-${{ matrix.test-file }}
        path: frontend/frontend.log
        retention-days: 3

    # Cleanup
    - name: Stop services
      if: always()
      run: |
        pkill -f "sam local" || true
        pkill -f "npm start" || true
        docker stop dynamodb || true
        docker rm dynamodb || true
        docker network rm e2e-network || true
